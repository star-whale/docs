"use strict";(self.webpackChunkstarwhale_docs=self.webpackChunkstarwhale_docs||[]).push([[7733],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>k});var n=a(67294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function p(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var o=n.createContext({}),u=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},m=function(e){var t=u(e.components);return n.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},s=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,i=e.originalType,o=e.parentName,m=p(e,["components","mdxType","originalType","parentName"]),s=u(a),k=l,N=s["".concat(o,".").concat(k)]||s[k]||d[k]||i;return a?n.createElement(N,r(r({ref:t},m),{},{components:a})):n.createElement(N,r({ref:t},m))}));function k(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var i=a.length,r=new Array(i);r[0]=s;var p={};for(var o in t)hasOwnProperty.call(t,o)&&(p[o]=t[o]);p.originalType=e,p.mdxType="string"==typeof e?e:l,r[1]=p;for(var u=2;u<i;u++)r[u]=a[u];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}s.displayName="MDXCreateElement"},91367:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>p,toc:()=>u});var n=a(83117),l=(a(67294),a(3905));const i={title:"Starwhale \u6a21\u578b\u8bc4\u6d4b SDK"},r=void 0,p={unversionedId:"reference/sdk/evaluation",id:"reference/sdk/evaluation",title:"Starwhale \u6a21\u578b\u8bc4\u6d4b SDK",description:"@evaluation.predict",source:"@site/i18n/zh/docusaurus-plugin-content-docs/current/reference/sdk/evaluation.md",sourceDirName:"reference/sdk",slug:"/reference/sdk/evaluation",permalink:"/zh/next/reference/sdk/evaluation",draft:!1,editUrl:"https://github.com/star-whale/docs/tree/main/docs/reference/sdk/evaluation.md",tags:[],version:"current",frontMatter:{title:"Starwhale \u6a21\u578b\u8bc4\u6d4b SDK"},sidebar:"mainSidebar",previous:{title:"Starwhale \u6570\u636e\u7c7b\u578b SDK",permalink:"/zh/next/reference/sdk/type"},next:{title:"Starwhale \u6a21\u578b SDK",permalink:"/zh/next/reference/sdk/model"}},o={},u=[{value:"@evaluation.predict",id:"evaluationpredict",level:2},{value:"\u63a7\u5236\u53c2\u6570",id:"predict-params",level:3},{value:"\u4f20\u5165\u53c2\u6570",id:"predict-input",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"predict-example",level:3},{value:"@evaluation.evaluate",id:"evaluationevaluate",level:2},{value:"\u53c2\u6570",id:"evaluate-params",level:3},{value:"\u8f93\u5165\u53c2\u6570",id:"evaluate-input",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"evaluate-example",level:3},{value:"evaluation.log",id:"evaluationlog",level:2},{value:"\u53c2\u6570",id:"log-params",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"log-example",level:3},{value:"evaluation.log_summary",id:"evaluationlog_summary",level:2},{value:"\u4f7f\u7528\u793a\u4f8b",id:"log-s-example",level:3},{value:"evaluation.iter",id:"evaluationiter",level:2},{value:"\u53c2\u6570",id:"iter-params",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"iter-example",level:3},{value:"@handler",id:"handler",level:2},{value:"\u53c2\u6570",id:"handler-params",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"handler-example",level:3},{value:"@fine_tune",id:"fine_tune",level:2},{value:"\u53c2\u6570",id:"ft-params",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"ft-example",level:3},{value:"@multi_classification",id:"multi_classification",level:2},{value:"\u53c2\u6570",id:"mc-params",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"mc-example",level:3},{value:"PipelineHandler",id:"pipelinehandler",level:2},{value:"\u53c2\u6570",id:"pl-params",level:3},{value:"PipelineHandler.run \u4fee\u9970\u7b26",id:"pl-run",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"pl-example",level:3},{value:"Context",id:"context",level:2},{value:"\u4f7f\u7528\u793a\u4f8b",id:"context-example",level:3},{value:"@starwhale.api.service.api",id:"starwhaleapiserviceapi",level:2},{value:"\u4f7f\u7528\u793a\u4f8b",id:"api-example",level:3},{value:"starwhale.api.service.Service",id:"starwhaleapiserviceservice",level:2},{value:"\u81ea\u5b9a\u4e49 Request \u548c Response",id:"\u81ea\u5b9a\u4e49-request-\u548c-response",level:3}],m={toc:u};function d(e){let{components:t,...a}=e;return(0,l.kt)("wrapper",(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"evaluationpredict"},"@evaluation.predict"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"@evaluation.predict")," \u662f\u4e00\u4e2a\u4fee\u9970\u5668\uff0c\u5b9a\u4e49\u6a21\u578b\u8bc4\u6d4b\u4e2d\u7684\u63a8\u7406\u8fc7\u7a0b\uff0c\u7c7b\u4f3c MapReduce \u4e2d\u7684 map \u9636\u6bb5\uff0c\u80fd\u591f\u5b8c\u6210\u5982\u4e0b\u6838\u5fc3\u529f\u80fd\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5728 Server \u5b9e\u4f8b\u4e0a\uff0c\u7533\u8bf7\u8fd0\u884c\u6240\u9700\u8981\u7684\u8d44\u6e90\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u81ea\u52a8\u8bfb\u53d6\u672c\u5730\u6216\u8fdc\u7aef\u7684\u6570\u636e\u96c6\uff0c\u5c06\u6570\u636e\u96c6\u4e2d\u7684\u6570\u636e\u4ee5\u5355\u6761\u6216\u6279\u91cf\u7684\u65b9\u5f0f\uff0c\u4f20\u9012\u7ed9 ",(0,l.kt)("inlineCode",{parentName:"li"},"evaluation.predict")," \u4fee\u9970\u7684\u51fd\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u901a\u8fc7\u591a\u526f\u672c\u7684\u8bbe\u7f6e\uff0c\u5b9e\u73b0",(0,l.kt)("strong",{parentName:"li"},"\u5206\u5e03\u5f0f\u6570\u636e\u96c6\u6d88\u8d39"),"\u7684\u529f\u80fd\uff0c\u80fd\u4ee5\u6c34\u5e73\u6269\u5c55\u7684\u65b9\u5f0f\u7f29\u77ed\u6a21\u578b\u8bc4\u6d4b\u4efb\u52a1\u7684\u7528\u65f6\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u81ea\u52a8\u5c06\u51fd\u6570\u8fd4\u56de\u503c\u548c\u6570\u636e\u96c6\u7684\u8f93\u5165 features \u5b58\u50a8\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"results")," \u8868\u4e2d\uff0c\u65b9\u4fbfWeb UI\u5c55\u793a\u548c\u8fdb\u4e00\u6b65\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"evaluate")," \u9636\u6bb5\u4f7f\u7528\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u6bcf\u5355\u6761\u6216\u6bcf\u6279\u91cf\u7ec4\u6570\u636e\u4f1a\u8c03\u7528\u4e00\u6b21\u88ab\u4fee\u9970\u7684\u51fd\u6570\uff0c\u5b8c\u6210\u63a8\u7406\u8fc7\u7a0b\u3002")),(0,l.kt)("h3",{id:"predict-params"},"\u63a7\u5236\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"resources"),": (dict, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5b9a\u4e49 ",(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u6bcf\u4e2a\u4efb\u52a1\u5728 Server \u5b9e\u4f8b\u4e0a\u8fd0\u884c\u65f6\u6240\u9700\u8981\u7684\u8d44\u6e90\uff0c\u5305\u62ec ",(0,l.kt)("inlineCode",{parentName:"li"},"memory"),"\uff0c",(0,l.kt)("inlineCode",{parentName:"li"},"cpu")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"nvidia.com/gpu")," \u4e09\u79cd\u7c7b\u578b\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"memory"),": \u5355\u4f4d\u4e3a Bytes\uff0c\u652f\u6301 int \u548c float \u7c7b\u578b\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u652f\u6301\u4ee5\u5b57\u5178\u7684\u65b9\u5f0f\u8bbe\u7f6e ",(0,l.kt)("inlineCode",{parentName:"li"},"request")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"limit"),"\uff0c\u6bd4\u5982 ",(0,l.kt)("inlineCode",{parentName:"li"},'resources={"memory": {"request": 100 * 1024, "limit": 200: 1024}}'),"\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u82e5\u4ec5\u8bbe\u7f6e\u5355\u4e2a\u6570\u5b57\uff0c\u5219 SDK \u4f1a\u81ea\u52a8\u5c06 ",(0,l.kt)("inlineCode",{parentName:"li"},"request")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"limit")," \u8bbe\u7f6e\u4e3a\u76f8\u540c\u7684\u6570\u503c\uff0c\u6bd4\u5982 ",(0,l.kt)("inlineCode",{parentName:"li"},'resources={"memory": 100 * 1024}')," \u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},'resources={"memory": {"request": 100 * 1024, "limit": 100 * 1024}}'),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"cpu"),": \u5355\u4f4d\u4e3a CPU \u6838\u5fc3\u6570\uff0c\u652f\u6301 int \u548c float \u7c7b\u578b\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u652f\u6301\u4ee5\u5b57\u5178\u7684\u65b9\u5f0f\u8bbe\u7f6e ",(0,l.kt)("inlineCode",{parentName:"li"},"request")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"limit"),"\uff0c\u6bd4\u5982 ",(0,l.kt)("inlineCode",{parentName:"li"},'resources={"cpu": {"request": 1, "limit": 2}}'),"\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u82e5\u4ec5\u8bbe\u7f6e\u5355\u4e2a\u6570\u5b57\uff0c\u5219 SDK \u4f1a\u81ea\u52a8\u5c06 ",(0,l.kt)("inlineCode",{parentName:"li"},"request")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"limit")," \u8bbe\u7f6e\u4e3a\u76f8\u540c\u7684\u6570\u503c\uff0c\u6bd4\u5982 ",(0,l.kt)("inlineCode",{parentName:"li"},'resources={"cpu": 1.5}')," \u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},'resources={"cpu": {"request": 1.5, "limit": 1.5}}'),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"nvidia.com/gpu"),": \u5355\u4f4d\u4e3a GPU\u663e\u5361\u6570\uff0c\u652f\u6301 int \u7c7b\u578b\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"nvidia.com/gpu")," \u4e0d\u652f\u6301\u8bbe\u7f6e ",(0,l.kt)("inlineCode",{parentName:"li"},"request")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"limit"),"\uff0c\u4ec5\u652f\u6301\u5355\u4e2a\u6570\u5b57\u3002"))))),(0,l.kt)("li",{parentName:"ul"},"\u9700\u8981\u6ce8\u610f\uff1a ",(0,l.kt)("strong",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"strong"},"resource")," \u53c2\u6570\u76ee\u524d\u4ec5\u5728 Server \u5b9e\u4f8b\u4e2d\u751f\u6548"),"\u3002Cloud \u5b9e\u4f8b\uff0c\u901a\u8fc7\u5728\u63d0\u4ea4\u8bc4\u6d4b\u4efb\u52a1\u65f6\uff0c\u9009\u62e9\u5bf9\u5e94\u7684",(0,l.kt)("strong",{parentName:"li"},"\u8d44\u6e90\u6c60"),"\u8fbe\u5230\u76f8\u540c\u7684\u4f5c\u7528\u3002Standalone \u5b9e\u4f8b\u5b8c\u5168\u4e0d\u652f\u6301\u8be5\u7279\u6027\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"replicas"),": (int, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u8fd0\u884c\u7684\u526f\u672c\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u76f8\u5f53\u4e8e\u5b9a\u4e49\u4e86\u4e00\u4e2a ",(0,l.kt)("inlineCode",{parentName:"li"},"Step"),", \u5728\u8be5 ",(0,l.kt)("inlineCode",{parentName:"li"},"Step")," \u4e2d\u6709\u82e5\u5e72\u7b49\u4ef7\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"Task"),"\uff0c\u6bcf\u4e2a ",(0,l.kt)("inlineCode",{parentName:"li"},"Task")," \u5728 Cloud/Server \u5b9e\u4f8b\u4e0a\u8fd0\u884c\u5b9e\u4f53\u662f Pod\uff0c\u5728 Standalone \u5b9e\u4f8b\u4e0a\u8fd0\u884c\u5b9e\u4f53\u662f Thread\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5f53\u6307\u5b9a\u591a\u4e2a\u526f\u672c\u65f6\uff0c\u8fd9\u4e9b\u526f\u672c\u662f\u7b49\u4ef7\u7684\uff0c\u5b83\u4eec\u4f1a\u5171\u540c\u6d88\u8d39\u9009\u5b9a\u7684\u6570\u636e\u96c6\uff0c\u5b9e\u73b0",(0,l.kt)("strong",{parentName:"li"},"\u5206\u5e03\u5f0f\u6570\u636e\u96c6\u6d88\u8d39"),"\u7684\u76ee\u7684\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u67d0\u4e2a\u6570\u636e\u96c6\u4e2d\u7684\u67d0\u884c\u6570\u636e\uff0c\u53ea\u4f1a\u88ab\u4e00\u4e2a ",(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u526f\u672c\u8bfb\u53d6\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u503c\u4e3a1\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"batch_size"),": (int, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u6279\u91cf\u5c06\u6570\u636e\u96c6\u4e2d\u7684\u6570\u636e\u4f20\u9012\u8fdb\u51fd\u6570\u4e2d\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u503c\u4e3a1\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"fail_on_error"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5f53\u88ab\u4fee\u9970\u7684\u51fd\u6570\u629b\u51fa\u5f02\u5e38\u65f6\uff0c\u662f\u5426\u4e2d\u65ad\u6240\u6709\u6a21\u578b\u8bc4\u6d4b\u3002\u5982\u679c\u9884\u671f\u67d0\u4e9b\u201c\u5f02\u5e38\u201d\u6570\u636e\u4f1a\u5bfc\u81f4\u8bc4\u6d4b\u5931\u8d25\uff0c\u4f46\u4e0d\u60f3\u4e2d\u65ad\u6574\u4f53\u8bc4\u6d4b\uff0c\u53ef\u4ee5\u8bbe\u7f6e ",(0,l.kt)("inlineCode",{parentName:"li"},"fail_on_error=False"),"\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"True"),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"auto_log"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u662f\u5426\u81ea\u52a8\u8bb0\u5f55\u51fd\u6570\u8fd4\u56de\u503c\u548c\u6570\u636e\u96c6\u8f93\u5165 features \u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"results")," \u8868\u4e2d\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"True"),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"log_mode"),": (str, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5f53 ",(0,l.kt)("inlineCode",{parentName:"li"},"auto_log=True")," \u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e ",(0,l.kt)("inlineCode",{parentName:"li"},"log_mode")," \u53c2\u6570\uff0c\u5b9a\u4e49\u4ee5 ",(0,l.kt)("inlineCode",{parentName:"li"},"plain")," \u6216 ",(0,l.kt)("inlineCode",{parentName:"li"},"pickle")," \u65b9\u5f0f\u8bb0\u5f55\u51fd\u6570\u8fd4\u56de\u503c\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"pickle")," \u65b9\u5f0f\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"log_dataset_features"),": (List","[str]",", optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5f53 ",(0,l.kt)("inlineCode",{parentName:"li"},"auto_log=True")," \u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u53c2\u6570\uff0c\u9009\u62e9\u6027\u7684\u8bb0\u5f55\u6570\u636e\u96c6\u4e2d\u7684\u67d0\u4e9b features \u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4f1a\u8bb0\u5f55\u6240\u6709\u7684 features \u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"needs"),": (List","[Callable]",", optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5b9a\u4e49\u8be5\u4efb\u52a1\u8fd0\u884c\u7684\u524d\u7f6e\u6761\u4ef6\uff0c\u53ef\u4ee5\u7528 needs \u8bed\u6cd5\u5b9e\u73b0 DAG\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"needs")," \u63a5\u53d7\u88ab ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.evaluate")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"@handler")," \u4fee\u9970\u7684\u51fd\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a\u7a7a\uff0c\u4e0d\u4f9d\u8d56\u4efb\u4f55\u5176\u4ed6\u4efb\u52a1\u3002")))),(0,l.kt)("h3",{id:"predict-input"},"\u4f20\u5165\u53c2\u6570"),(0,l.kt)("p",null,"\u88ab\u4fee\u9970\u7684\u51fd\u6570\uff0c\u9700\u8981\u5b9a\u4e49\u4e00\u4e9b\u8f93\u5165\u53c2\u6570\uff0c\u7528\u6765\u63a5\u53d7\u6570\u636e\u96c6\u5185\u5bb9\u7b49\uff0c\u5305\u542b\u5982\u4e0b\u6a21\u5f0f\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u5355\u4e2a ",(0,l.kt)("inlineCode",{parentName:"p"},"data")," \u53c2\u6570\uff1a"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"data")," \u4e3a \u4e00\u4e2a\u7c7b dict \u7c7b\u578b\uff0c\u80fd\u591f\u8bfb\u53d6\u5230\u6570\u636e\u96c6\u7684 features \u5185\u5bb9\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5f53 ",(0,l.kt)("inlineCode",{parentName:"li"},"batch_size=1")," \u6216\u4e0d\u8bbe\u7f6e ",(0,l.kt)("inlineCode",{parentName:"li"},"batch_size")," \u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"li"},"data['label']")," \u6216 ",(0,l.kt)("inlineCode",{parentName:"li"},"data.label")," \u65b9\u5f0f\u8bfb\u53d6 label feature\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5f53\u8bbe\u7f6e ",(0,l.kt)("inlineCode",{parentName:"li"},"batch_size")," > 1 \u65f6\uff0c",(0,l.kt)("inlineCode",{parentName:"li"},"data")," \u4e3a\u4e00\u4e2a list\u3002")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-python"},"from starwhale import evaluation\n\n@evaluation.predict\ndef predict(data):\n    print(data['label'])\n    print(data.label)\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"data")," + ",(0,l.kt)("inlineCode",{parentName:"p"},"external")," \u53c2\u6570\u65b9\u5f0f\uff1a"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"data")," \u4e3a\u6570\u636e\u96c6\u7684features\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"external")," \u4e3a\u4e00\u4e2a dict \u7c7b\u578b\uff0c\u5305\u542b ",(0,l.kt)("inlineCode",{parentName:"li"},"index"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"index_with_dataset"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"dataset_info"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"context")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"dataset_uri")," \u8fd9\u4e9b\u5185\u5efa\u5c5e\u6027\uff0c\u53ef\u4ee5\u7528\u6765\u505a\u66f4\u7ec6\u7c92\u5ea6\u7684\u5904\u7406\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"index"),": \u6570\u636e\u96c6\u5bf9\u5e94\u884c\u7684 index \u4fe1\u606f\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"index_with_dataset"),": \u9002\u7528\u4e8e\u591a\u4e2a\u6570\u636e\u96c6\u8f93\u5165\u7684\u65f6\u5019\u505a index \u533a\u5206\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"dataset_info"),": ",(0,l.kt)("inlineCode",{parentName:"li"},"starwhale.core.dataset.tabular.TabularDatasetInfo")," \u5bf9\u8c61\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"context"),": ",(0,l.kt)("inlineCode",{parentName:"li"},"starwhale.Context")," \u5bf9\u8c61\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"dataset_uri"),": ",(0,l.kt)("inlineCode",{parentName:"li"},"starwhale.nase.uri.resource.Resource")," \u5bf9\u8c61\u3002")))),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\n@evaluation.predict\ndef predict(data, external):\n    print(data[\'label\'])\n    print(data.label)\n    print(external["context"])\n    print(external["dataset_uri"])\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"data")," + ",(0,l.kt)("inlineCode",{parentName:"p"},"**kw")," \u65b9\u5f0f\uff1a"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"data")," \u4e3a\u6570\u636e\u96c6\u7684features\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"kw")," \u53ef\u4ee5\u8bfb\u53d6\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"external"),"\u3002")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\n@evaluation.predict\ndef predict(data, **kw):\n    print(kw["external"]["context"])\n    print(kw["external"]["dataset_uri"])\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"*args")," + ",(0,l.kt)("inlineCode",{parentName:"p"},"**kwargs")," \u65b9\u5f0f\uff1a"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"args\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"data"),"\u3002")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\n@evaluation.predict\ndef predict(*args, **kw):\n    print(args[0].label)\n    print(args[0]["label"])\n    print(kw["external"]["context"])\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"**kwargs")," \u65b9\u5f0f\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\n@evaluation.predict\ndef predict(**kw):\n    print(kw["data"].label)\n    print(kw["data"]["label"])\n    print(kw["external"]["context"])\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"*args")," \u65b9\u5f0f\uff1a"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u6b64\u65b9\u5f0f\u65e0\u6cd5\u8bfb\u53d6\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"external")," \u4fe1\u606f\u3002")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\n@evaluation.predict\ndef predict(*args):\n    print(args[0].label)\n    print(args[0]["label"])\n')))),(0,l.kt)("h3",{id:"predict-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\n@evaluation.predict\ndef predict_image(data):\n    ...\n\n@evaluation.predict(\n    dataset="mnist/version/latest",\n    batch_size=32,\n    replicas=4,\n    needs=[predict_image],\n)\ndef predict_batch_images(batch_data)\n    ...\n\n@evaluation.predict(\n    resources={"nvidia.com/gpu": 1,\n               "cpu": {"request": 1, "limit": 2},\n               "memory": 200 * 1024},  # 200MB\n    log_mode="plain",\n)\ndef predict_with_resources(data):\n    ...\n\n@evaluation.predict(\n    replicas=1,\n    log_mode="plain",\n    log_dataset_features=["txt", "img", "label"],\n)\ndef predict_with_selected_features(data):\n    ...\n')),(0,l.kt)("h2",{id:"evaluationevaluate"},"@evaluation.evaluate"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"@evaluation.evalute")," \u662f\u4e00\u4e2a\u4fee\u9970\u5668\uff0c\u5b9a\u4e49\u6a21\u578b\u8bc4\u6d4b\u4e2d\u7684\u8bc4\u6d4b\u8fc7\u7a0b\uff0c\u7c7b\u4f3c MapReduce \u4e2d\u7684 reduce \u9636\u6bb5\uff0c\u80fd\u591f\u5b8c\u6210\u5982\u4e0b\u6838\u5fc3\u529f\u80fd\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5728 Server \u5b9e\u4f8b\u4e0a\uff0c\u7533\u8bf7\u8fd0\u884c\u6240\u9700\u8981\u7684\u8d44\u6e90\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u81ea\u52a8\u8bfb\u53d6 ",(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u9636\u6bb5\u8bb0\u5f55\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"results")," \u8868\u7684\u6570\u636e\uff0c\u5e76\u4ee5\u8fed\u4ee3\u5668\u7684\u65b9\u5f0f\u4f20\u5165\u51fd\u6570\u4e2d\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"evaluate")," \u9636\u6bb5\u53ea\u4f1a\u8fd0\u884c\u4e00\u4e2a\u526f\u672c\uff0c\u65e0\u6cd5\u50cf ",(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u9636\u6bb5\u4e00\u6837\u5b9a\u4e49 ",(0,l.kt)("inlineCode",{parentName:"li"},"replicas")," \u53c2\u6570\u3002")),(0,l.kt)("h3",{id:"evaluate-params"},"\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"resources"),": (dict, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"resources")," \u53c2\u6570\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"needs"),": (List","[Callable]",", optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"needs")," \u53c2\u6570\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u7edd\u5927\u591a\u6570\u573a\u666f\u4e2d\uff0c\u4f1a\u4f9d\u8d56\u4e00\u4e2a ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4fee\u9970\u7684\u51fd\u6570\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"use_predict_auto_log"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"True"),"\uff0c\u4f20\u5165\u4e00\u4e2a\u80fd\u591f\u80fd\u591f\u904d\u5386 ",(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u7ed3\u679c\u7684\u8fed\u4ee3\u5668\u5230\u51fd\u6570\u4e2d\u3002")))),(0,l.kt)("h3",{id:"evaluate-input"},"\u8f93\u5165\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5f53 ",(0,l.kt)("inlineCode",{parentName:"li"},"use_predict_auto_log=True"),"\uff08\u9ed8\u8ba4\uff09\u65f6\uff0c\u4f20\u5165\u4e00\u4e2a\u80fd\u591f\u80fd\u591f\u904d\u5386 ",(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u7ed3\u679c\u7684\u8fed\u4ee3\u5668\u5230\u51fd\u6570\u4e2d\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u8fed\u4ee3\u51fa\u6765\u7684\u5bf9\u8c61\u4e3a\u4e00\u4e2a\u5b57\u5178\uff0c\u5305\u542b ",(0,l.kt)("inlineCode",{parentName:"li"},"output")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"input")," \u4e24\u4e2akey\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"output")," \u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u9636\u6bb5\u51fd\u6570\u8fd4\u56de\u7684\u5143\u7d20\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"input")," \u4e3a\u63a8\u7406\u65f6\u5bf9\u5e94\u4f7f\u7528\u7684\u6570\u636e\u96c6\u7684 features ,\u4e3a\u4e00\u4e2a\u5b57\u5178\u7c7b\u578b\u3002"))))),(0,l.kt)("li",{parentName:"ul"},"\u5f53 ",(0,l.kt)("inlineCode",{parentName:"li"},"use_predict_auto_log=False")," \u65f6\uff0c\u4e0d\u4f20\u5165\u4efb\u4f55\u53c2\u6570\u5230\u51fd\u6570\u4e2d\u3002")),(0,l.kt)("h3",{id:"evaluate-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"from starwhale import evaluation\n\n@evaluation.evaluate(needs=[predict_image])\ndef evaluate_results(predict_result_iter):\n    ...\n\n@evaluation.evaluate(\n    use_predict_auto_log=False,\n    needs=[predict_image],\n)\ndef evaluate_results():\n    ...\n")),(0,l.kt)("h2",{id:"evaluationlog"},"evaluation.log"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"evaluation.log")," \u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u8bb0\u5f55\u67d0\u4e9b\u8bc4\u6d4b\u6307\u6807\u5230\u7279\u5b9a\u8868\u4e2d\uff0c\u4e4b\u540e\u53ef\u4ee5\u901a\u8fc7 Server/Cloud \u5b9e\u4f8b\u7684 Web \u9875\u9762\u4e2d\u67e5\u770b\u76f8\u5173\u7684\u8868\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"@classmethod\ndef log(\n    cls, category: str, id: t.Union[str, int], metrics: t.Dict[str, t.Any]\n) -> None:\n")),(0,l.kt)("h3",{id:"log-params"},"\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"category"),": (str, required)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u8bb0\u5f55\u7684\u7c7b\u522b\uff0c\u8be5\u503c\u4f1a\u88ab\u4f5c\u4e3a Starwhale Datastore \u7684\u8868\u540d\u7684\u540e\u7f00\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u4e00\u4e2a ",(0,l.kt)("inlineCode",{parentName:"li"},"category")," \u4f1a\u5bf9\u5e94\u4e00\u5f20 Starwhale Datastore \u7684\u8868\uff0c\u8fd9\u4e9b\u8868\u4f1a\u4ee5\u8bc4\u6d4b\u4efb\u52a1ID\u4f5c\u4e3a\u9694\u79bb\u533a\u5206\uff0c\u76f8\u4e92\u4e0d\u5f71\u54cd\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"id"),": (str|int, required)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u8bb0\u5f55\u7684ID\uff0c\u8868\u5185\u552f\u4e00\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u540c\u4e00\u5f20\u8868\uff0c\u53ea\u80fd\u91c7\u7528 str \u6216 int \u7684\u4e00\u79cd\u7c7b\u578b\u4f5c\u4e3a ID \u7c7b\u578b\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"metrics"),": (dict, required)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5b57\u5178\u7c7b\u578b\uff0ckey-value \u65b9\u5f0f\u8bb0\u5f55\u6307\u6807\u3002")))),(0,l.kt)("h3",{id:"log-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\nevaluation.log("label/1", 1, {"loss": 0.99, "accuracy": 0.98})\nevaluation.log("ppl", "1", {"a": "test", "b": 1})\n')),(0,l.kt)("h2",{id:"evaluationlog_summary"},"evaluation.log_summary"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"evaluation.log_summary")," \u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u8bb0\u5f55\u67d0\u4e9b\u6307\u6807\u5230 summary \u8868\u4e2d\uff0cServer/Cloud \u5b9e\u4f8b\u8bc4\u6d4b\u9875\u9762\u663e\u793a\u7684\u5c31\u662f summary \u8868\u7684\u6570\u636e\u3002\n\u6bcf\u6b21\u8c03\u7528\uff0cStarwhale \u90fd\u4f1a\u81ea\u52a8\u4ee5\u6b64\u6b21\u8bc4\u6d4b\u7684\u552f\u4e00ID\u4f5c\u4e3a\u8868\u7684\u884cID\u8fdb\u884c\u66f4\u65b0\uff0c\u53ef\u4ee5\u518d\u4e00\u6b21\u8bc4\u6d4b\u8fc7\u7a0b\u4e2d\u591a\u6b21\u8c03\u7528\u8be5\u51fd\u6570\uff0c\u7528\u6765\u66f4\u65b0\u4e0d\u540c\u7684\u5217\u3002"),(0,l.kt)("p",null,"\u6bcf\u4e2a\u9879\u76ee\u4e2d\u6709\u4e00\u5f20 summary \u8868\uff0c\u6240\u6709\u8be5\u9879\u76ee\u4e0b\u7684\u8bc4\u6d4b\u4efb\u52a1\u90fd\u4f1a\u5c06 summary \u4fe1\u606f\u5199\u5165\u8be5\u8868\u4e2d\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"@classmethod\ndef log_summary(cls, *args: t.Any, **kw: t.Any) -> None:\n")),(0,l.kt)("h3",{id:"log-s-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\nevaluation.log_summary(loss=0.99)\nevaluation.log_summary(loss=0.99, accuracy=0.99)\nevaluation.log_summary({"loss": 0.99, "accuracy": 0.99})\n')),(0,l.kt)("h2",{id:"evaluationiter"},"evaluation.iter"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"evaluation.iter")," \u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u8fd4\u56de\u4e00\u4e2a\u8fed\u4ee3\u5668\uff0c\u7528\u6765\u8fed\u4ee3\u5f0f\u7684\u8bfb\u53d6\u67d0\u4e9b\u6a21\u578b\u8bc4\u6d4b\u8868\u4e2d\u7684\u6570\u636e\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"@classmethod\ndef iter(cls, category: str) -> t.Iterator:\n")),(0,l.kt)("h3",{id:"iter-params"},"\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"category"),": (str, required)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"evaluation.log")," \u51fd\u6570\u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"category")," \u53c2\u6570\u542b\u4e49\u4e00\u81f4\u3002")))),(0,l.kt)("h3",{id:"iter-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import evaluation\n\nresults = [data for data in evaluation.iter("label/0")]\n')),(0,l.kt)("h2",{id:"handler"},"@handler"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"@handler")," \u662f\u4e00\u4e2a\u4fee\u9970\u5668\uff0c\u5177\u5907\u5982\u4e0b\u529f\u80fd\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5728 Server \u5b9e\u4f8b\u4e0a\uff0c\u7533\u8bf7\u8fd0\u884c\u6240\u9700\u8981\u7684\u8d44\u6e90\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u53ef\u4ee5\u63a7\u5236\u526f\u672c\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u591a\u4e2a Handlers \u53ef\u4ee5\u901a\u8fc7\u4f9d\u8d56\u5173\u7cfb\uff0c\u751f\u6210DAG\uff0c\u4fbf\u4e8e\u63a7\u5236\u6267\u884c\u6d41\u7a0b\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u53ef\u4ee5\u5bf9\u5916\u66b4\u9732\u7aef\u53e3\uff0c\u4ee5\u7c7b\u4f3c Web Handler \u65b9\u5f0f\u8fd0\u884c\u3002")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"@fine_tune"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"@evaluation.predict")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"@evaluation.evalute")," \u53ef\u4ee5\u8ba4\u4e3a\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"@handler")," \u5728\u67d0\u4e9b\u7279\u5b9a\u9886\u57df\u7684\u5e94\u7528\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"@handler")," \u662f\u8fd9\u4e9b\u4fee\u9970\u5668\u7684\u5e95\u5c42\u5b9e\u73b0\u3002",(0,l.kt)("inlineCode",{parentName:"p"},"@handler")," \u66f4\u4e3a\u57fa\u7840\u548c\u7075\u6d3b\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'@classmethod\ndef handler(\n    cls,\n    resources: t.Optional[t.Dict[str, t.Any]] = None,\n    replicas: int = 1,\n    needs: t.Optional[t.List[t.Callable]] = None,\n    name: str = "",\n    expose: int = 0,\n    require_dataset: bool = False,\n) -> t.Callable:\n')),(0,l.kt)("h3",{id:"handler-params"},"\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"resources"),": (dict, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"resources")," \u53c2\u6570\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"needs"),": (List","[Callable]",", optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"needs")," \u53c2\u6570\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"replicas"),": (int, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"replicas")," \u53c2\u6570\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"name"),": (str, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u663e\u793a handler \u65f6\u5019\u7528\u7684\u540d\u5b57\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u82e5\u4e0d\u6307\u5b9a\uff0c\u5219\u7528\u4fee\u9970\u51fd\u6570\u7684\u540d\u5b57\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"expose"),": (int, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5bf9\u5916\u66b4\u9732\u7684\u7aef\u53e3\uff0c\u5f53\u8fd0\u884c\u4e00\u4e2a Web Handler\u7684\u65f6\u5019\uff0c\u9700\u8981\u58f0\u660e\u66b4\u9732\u7684\u7aef\u53e3\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a0\uff0c\u8868\u793a\u4e0d\u66b4\u9732\u4efb\u4f55\u7aef\u53e3\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u76ee\u524d\u53ea\u80fd\u66b4\u9732\u4e00\u4e2a\u7aef\u53e3\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"require_dataset"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5b9a\u4e49\u6b64 Handler \u8fd0\u884c\u65f6\uff0c\u662f\u5426\u9700\u8981\u6570\u636e\u96c6\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c ",(0,l.kt)("inlineCode",{parentName:"li"},"required_dataset=True"),"\uff0c\u5728 Server/Cloud \u5b9e\u4f8b\u7684 Web \u754c\u9762\u521b\u5efa\u8bc4\u6d4b\u4efb\u52a1\u7684\u65f6\u5019\uff0c\u9700\u8981\u8ba9\u7528\u6237\u5f3a\u5236\u8f93\u5165\u6570\u636e\u96c6\uff1b\u5982\u679c ",(0,l.kt)("inlineCode",{parentName:"li"},"required_dataset=False"),"\uff0c\u5219 Web \u754c\u9762\u4e2d\u4e0d\u9700\u8981\u7528\u6237\u6307\u5b9a\u6570\u636e\u96c6\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"False"),"\u3002")))),(0,l.kt)("h3",{id:"handler-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import handler\nimport gradio\n\n@handler(resources={"cpu": 1, "nvidia.com/gpu": 1}, replicas=3)\ndef my_handler():\n    ...\n\n@handler(needs=[my_handler])\ndef my_another_handler():\n    ...\n\n@handler(expose=7860)\ndef chatbot():\n    with gradio.Blocks() as server:\n        ...\n    server.launch(server_name="0.0.0.0", server_port=7860)\n')),(0,l.kt)("h2",{id:"fine_tune"},"@fine_tune"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"fine_tune")," \u662f\u4e00\u4e2a\u4fee\u9970\u5668\uff0c\u5b9a\u4e49\u6a21\u578b\u8bad\u7ec3\u7684\u5fae\u8c03(fine-tune)\u8fc7\u7a0b\u3002"),(0,l.kt)("p",null,"\u4e00\u4e9b\u9650\u5236\u548c\u4f7f\u7528\u5efa\u8bae\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"fine_tune")," \u53ea\u6709\u4e00\u4e2a\u526f\u672c\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"fine_tune")," \u9700\u8981\u6709\u6570\u636e\u96c6\u8f93\u5165\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u4e00\u822c\u5728 ",(0,l.kt)("inlineCode",{parentName:"li"},"fine_tune")," \u5f00\u59cb\u65f6\uff0c\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"li"},"Context.get_runtime_context()")," \u83b7\u53d6\u6570\u636e\u96c6\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u4e00\u822c\u5728 ",(0,l.kt)("inlineCode",{parentName:"li"},"fine_tune")," \u7ed3\u675f\u662f\uff0c\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"li"},"starwhale.model.build")," \u751f\u6210\u5fae\u8c03\u540e\u7684Starwhale \u6a21\u578b\u5305\uff0c\u8be5\u6a21\u578b\u5305\u4f1a\u88ab\u81ea\u52a8\u590d\u5236\u5230\u8bc4\u6d4b\u5bf9\u5e94\u7684\u9879\u76ee\u4e2d\u3002")),(0,l.kt)("h3",{id:"ft-params"},"\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"resources"),": (dict, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"resources")," \u53c2\u6570\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"needs"),": (List","[Callable]",", optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"needs")," \u53c2\u6570\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002")))),(0,l.kt)("h3",{id:"ft-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'from starwhale import model as starwhale_model\nfrom starwhale import fine_tune, Context\n\n@fine_tune(resources={"nvidia.com/gpu": 1})\ndef llama_fine_tuning():\n    ctx = Context.get_runtime_context()\n\n    if len(ctx.dataset_uris) == 2:\n        # TODO: use more graceful way to get train and eval dataset\n        train_dataset = dataset(ctx.dataset_uris[0], readonly=True, create="forbid")\n        eval_dataset = dataset(ctx.dataset_uris[1], readonly=True, create="forbid")\n    elif len(ctx.dataset_uris) == 1:\n        train_dataset = dataset(ctx.dataset_uris[0], readonly=True, create="forbid")\n        eval_dataset = None\n    else:\n        raise ValueError("Only support 1 or 2 datasets(train and eval dataset) for now")\n\n    #user training code\n    train_llama(\n        train_dataset=train_dataset,\n        eval_dataset=eval_dataset,\n    )\n\n    model_name = get_model_name()\n    starwhale_model.build(name=f"llama-{model_name}-qlora-ft")\n')),(0,l.kt)("h2",{id:"multi_classification"},"@multi_classification"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"@multi_classification")," \u4fee\u9970\u5668\u4f7f\u7528sklearn lib\u5bf9\u591a\u5206\u7c7b\u95ee\u9898\u8fdb\u884c\u7ed3\u679c\u5206\u6790\uff0c\u8f93\u51faconfusion matrix, roc, auc\u7b49\u503c\uff0c\u5e76\u4e14\u4f1a\u5199\u5165\u5230 starwhale DataStore \u76f8\u5173\u8868\u4e2d\u3002\n\u4f7f\u7528\u7684\u65f6\u5019\u9700\u8981\u5bf9\u6240\u4fee\u9970\u7684\u51fd\u6570\u8fd4\u56de\u503c\u6709\u4e00\u5b9a\u8981\u6c42\uff0c\u8fd4\u56de",(0,l.kt)("inlineCode",{parentName:"p"},"(label, result, probability_matrix)")," \u6216 ",(0,l.kt)("inlineCode",{parentName:"p"},"(label, result)"),"\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'def multi_classification(\n    confusion_matrix_normalize: str = "all",\n    show_hamming_loss: bool = True,\n    show_cohen_kappa_score: bool = True,\n    show_roc_auc: bool = True,\n    all_labels: t.Optional[t.List[t.Any]] = None,\n) -> t.Any:\n')),(0,l.kt)("h3",{id:"mc-params"},"\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"confusion_matrix_normalize"),": (str, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u63a5\u6536\u4e09\u79cd\u53c2\u6570\uff1a",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"true"),": rows"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"pred"),": columns"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"all"),": rows+columns"))))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"show_hamming_loss"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u662f\u5426\u8ba1\u7b97hamming loss\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"True"),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"show_cohen_kappa_score"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u662f\u5426\u8ba1\u7b97 cohen kappa score\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"True"),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"show_roc_auc"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u662f\u5426\u8ba1\u7b97roc/auc, \u8ba1\u7b97\u7684\u65f6\u5019\uff0c\u9700\u8981\u51fd\u6570\u8fd4\u56de(label\uff0cresult, probability_matrix) \u4e09\u5143\u7ec4\uff0c\u5426\u5219\u53ea\u9700\u8fd4\u56de(label, result) \u4e24\u5143\u7ec4\u5373\u53ef\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"True"),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"all_labels"),": (List, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5b9a\u4e49\u6240\u6709\u7684Labels\u3002")))),(0,l.kt)("h3",{id:"mc-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'\n@multi_classification(\n    confusion_matrix_normalize="all",\n    show_hamming_loss=True,\n    show_cohen_kappa_score=True,\n    show_roc_auc=True,\n    all_labels=[i for i in range(0, 10)],\n)\ndef evaluate(ppl_result) -> t.Tuple[t.List[int], t.List[int], t.List[t.List[float]]]:\n    label, result, probability_matrix = [], [], []\n    return label, result, probability_matrix\n\n@multi_classification(\n    confusion_matrix_normalize="all",\n    show_hamming_loss=True,\n    show_cohen_kappa_score=True,\n    show_roc_auc=False,\n    all_labels=[i for i in range(0, 10)],\n)\ndef evaluate(ppl_result) -> t.Tuple[t.List[int], t.List[int], t.List[t.List[float]]]:\n    label, result = [], [], []\n    return label, result\n')),(0,l.kt)("h2",{id:"pipelinehandler"},"PipelineHandler"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"PipelineHandler")," \u662f\u4e00\u4e2a\u7c7b\uff0c\u63d0\u4f9b\u9ed8\u8ba4\u7684\u6a21\u578b\u8bc4\u6d4b\u8fc7\u7a0b\u5b9a\u4e49\uff0c\u9700\u8981\u7528\u6237\u5b9e\u73b0 ",(0,l.kt)("inlineCode",{parentName:"p"},"predict")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"evaluate")," \u51fd\u6570\u3002"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"PipelineHandler")," \u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"p"},"@evaluation.predict")," + ",(0,l.kt)("inlineCode",{parentName:"p"},"@evaluation.evaluate"),"\uff0c\u5c55\u793a\u4f7f\u7528\u65b9\u5f0f\u4e0d\u4e00\u6837\uff0c\u80cc\u540e\u7684\u6a21\u578b\u8bc4\u6d4b\u8fc7\u7a0b\u4e00\u81f4\u3002"),(0,l.kt)("p",null,"\u7528\u6237\u9700\u8981\u5b9e\u73b0\u5982\u4e0b\u51fd\u6570\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"predict"),": \u5b9a\u4e49\u63a8\u7406\u8fc7\u7a0b\uff0c\u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4fee\u9970\u7684\u51fd\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"evaluate"),": \u5b9a\u4e49\u8bc4\u6d4b\u8fc7\u7a0b\uff0c\u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.evaluate")," \u4fee\u9970\u7684\u51fd\u6570\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"from typing import Any, Iterator\nfrom abc import ABCMeta, abstractmethod\n\nclass PipelineHandler(metaclass=ABCMeta):\n    def __init__(\n        self,\n        predict_batch_size: int = 1,\n        ignore_error: bool = False,\n        predict_auto_log: bool = True,\n        predict_log_mode: str = PredictLogMode.PICKLE.value,\n        predict_log_dataset_features: t.Optional[t.List[str]] = None,\n        **kwargs: t.Any,\n    ) -> None:\n        self.context = Context.get_runtime_context()\n        ...\n\n    def predict(self, data: Any, **kw: Any) -> Any:\n        raise NotImplementedError\n\n    def evaluate(self, ppl_result: Iterator) -> Any\n        raise NotImplementedError\n")),(0,l.kt)("h3",{id:"pl-params"},"\u53c2\u6570"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"predict_batch_size"),": (int, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"batch_size")," \u53c2\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u503c\u4e3a1\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ignore_error"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"fail_on_error")," \u53c2\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u503c\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"False"),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"predict_auto_log"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"auto_log")," \u53c2\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u503c\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"True"),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"predict_log_mode"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"log_mode")," \u53c2\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u503c\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"pickle"),"\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"predict_log_dataset_features"),": (bool, optional)",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u7b49\u4ef7\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"log_dataset_features")," \u53c2\u6570\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u503c\u4e3a\u7a7a\uff0c\u5bf9\u8bb0\u5f55\u6240\u6709 features\u3002")))),(0,l.kt)("h3",{id:"pl-run"},"PipelineHandler.run \u4fee\u9970\u7b26"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"PipelineHandler.run")," \u4fee\u9970\u7b26\u53ef\u4ee5\u5bf9 ",(0,l.kt)("inlineCode",{parentName:"p"},"predict")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"evaluate")," \u65b9\u6cd5\u8fdb\u884c\u8d44\u6e90\u63cf\u8ff0\uff0c\u652f\u6301 ",(0,l.kt)("inlineCode",{parentName:"p"},"replicas")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"resources")," \u7684\u5b9a\u4e49\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"PipelineHandler.run")," \u53ea\u80fd\u4fee\u9970\u7ee7\u627f\u81ea ",(0,l.kt)("inlineCode",{parentName:"li"},"PipelineHandler")," \u5b50\u7c7b\u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"evaluate"),"\u65b9\u6cd5\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"predict")," \u65b9\u6cd5\u53ef\u4ee5\u8bbe\u7f6e ",(0,l.kt)("inlineCode",{parentName:"li"},"replicas")," \u53c2\u6570\u3002",(0,l.kt)("inlineCode",{parentName:"li"},"evaluate")," \u65b9\u6cd5\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"replicas")," \u503c\u6c38\u8fdc\u4e3a1\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"resources")," \u53c2\u6570\u4e0e ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.predict")," \u6216 ",(0,l.kt)("inlineCode",{parentName:"li"},"@evaluation.evaluate")," \u4e2d\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"resources")," \u53c2\u6570\u5b9a\u4e49\u548c\u4f7f\u7528\u65b9\u6cd5\u4fdd\u6301\u4e00\u81f4\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"PipelineHandler.run")," \u4fee\u9970\u5668\u662f\u53ef\u9009\u7684\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"PipelineHandler.run")," \u4ec5\u5728 Server \u548c Cloud \u5b9e\u4f8b\u4e2d\u751f\u6548\uff0cStandalone \u5b9e\u4f8b\u4e0d\u652f\u6301\u8d44\u6e90\u5b9a\u4e49\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"@classmethod\ndef run(\n    cls, resources: t.Optional[t.Dict[str, t.Any]] = None, replicas: int = 1\n) -> t.Callable:\n")),(0,l.kt)("h3",{id:"pl-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'import typing as t\n\nimport torch\nfrom starwhale import PipelineHandler\n\nclass Example(PipelineHandler):\n    def __init__(self) -> None:\n        super().__init__()\n        self.device = torch.device("cuda" if torch.cuda.is_available() else "cpu")\n        self.model = self._load_model(self.device)\n\n    @PipelineHandler.run(replicas=4, resources={"memory": 1 * 1024 * 1024 *1024, "nvidia.com/gpu": 1}) # 1G Memory, 1 GPU\n    def predict(self, data: t.Dict):\n        data_tensor = self._pre(data.img)\n        output = self.model(data_tensor)\n        return self._post(output)\n\n    @PipelineHandler.run(resources={"memory": 1 * 1024 * 1024 *1024}) # 1G Memory\n    def evaluate(self, ppl_result):\n        result, label, pr = [], [], []\n        for _data in ppl_result:\n            label.append(_data["input"]["label"])\n            result.extend(_data["output"][0])\n            pr.extend(_data["output"][1])\n        return label, result, pr\n\n    def _pre(self, input: Image) -> torch.Tensor:\n        ...\n\n    def _post(self, input):\n        ...\n\n    def _load_model(self, device):\n        ...\n')),(0,l.kt)("h2",{id:"context"},"Context"),(0,l.kt)("p",null,"\u6267\u884c\u6a21\u578b\u8bc4\u6d4b\u8fc7\u7a0b\u4e2d\u4f20\u5165\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u5305\u62ecProject\u3001Task ID\u7b49\u3002Context \u7684\u5185\u5bb9\u662f\u81ea\u52a8\u6ce8\u5165\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u5f0f\u4f7f\u7528\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u7ee7\u627f ",(0,l.kt)("inlineCode",{parentName:"li"},"PipelineHandler")," \u7c7b\u5185\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},"self.context")," \u5bf9\u8c61\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"li"},"Context.get_runtime_context()")," \u83b7\u53d6\u3002")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u9700\u8981\u6ce8\u610f\uff0c\u53ea\u6709\u5728\u6a21\u578b\u8bc4\u6d4b\u8fc7\u7a0b\u4e2d\uff0c\u624d\u80fd\u4f7f\u7528",(0,l.kt)("inlineCode",{parentName:"strong"},"Context"),"\uff0c\u5426\u5219\u7a0b\u5e8f\u4f1a\u629b\u51fa\u5f02\u5e38\u3002")),(0,l.kt)("p",null,"\u76ee\u524dContext\u53ef\u4ee5\u83b7\u5f97\u5982\u4e0b\u503c\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"project"),": str",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Project \u540d\u5b57\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"version"),": str",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u6a21\u578b\u8bc4\u6d4b\u7684\u552f\u4e00ID\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"step"),": str",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Step \u540d\u5b57\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"total"),": int",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Step \u4e0b\u6240\u6709 Task \u7684\u6570\u91cf\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"index"),": int",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Task \u7d22\u5f15\u6807\u53f7\uff0c\u4e0b\u6807\u4ece0\u5f00\u59cb\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"dataset_uris"),": List","[str]",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Starwhale \u6570\u636e\u96c6\u7684URI \u5217\u8868\u3002")))),(0,l.kt)("h3",{id:"context-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"\nfrom starwhale import Context, PipelineHandler\n\ndef func():\n    ctx = Context.get_runtime_context()\n    print(ctx.project)\n    print(ctx.version)\n    print(ctx.step)\n    ...\n\nclass Example(PipelineHandler):\n\n    def predict(self, data: t.Dict):\n        print(self.context.project)\n        print(self.context.version)\n        print(self.context.step)\n")),(0,l.kt)("h2",{id:"starwhaleapiserviceapi"},"@starwhale.api.service.api"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"@starwhale.api.service.api")," \u662f\u4e00\u4e2a\u4fee\u9970\u5668\uff0c\u63d0\u4f9b\u57fa\u4e8e Gradio \u7684\u7b80\u6613 Web Handler \u8f93\u5165\u5b9a\u4e49\uff0c\u5f53\u7528\u6237\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"swcli model serve")," \u547d\u4ee4\u542f\u52a8 Web Service \u63a5\u6536\u5916\u90e8\u8bf7\u6c42\uff0c\u5e76\u5c06\u63a8\u7406\u7ed3\u679c\u8fd4\u56de\u7ed9\u7528\u6237\uff0c\u5b9e\u73b0\u5728\u7ebf\u8bc4\u6d4b\u3002"),(0,l.kt)("h3",{id:"api-example"},"\u4f7f\u7528\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'import gradio\nfrom starwhale.api.service import api\n\ndef predict_image(img):\n    ...\n\n@api(gradio.File(), gradio.Label())\ndef predict_view(file: t.Any) -> t.Any:\n    with open(file.name, "rb") as f:\n        data = Image(f.read(), shape=(28, 28, 1))\n    _, prob = predict_image({"img": data})\n    return {i: p for i, p in enumerate(prob)}\n')),(0,l.kt)("h2",{id:"starwhaleapiserviceservice"},"starwhale.api.service.Service"),(0,l.kt)("p",null,"\u5982\u679c\u5e0c\u671b\u81ea\u5b9a\u4e49 web service \u7684\u5b9e\u73b0, \u53ef\u4ee5\u7ee7\u627f ",(0,l.kt)("inlineCode",{parentName:"p"},"Service")," \u5e76\u91cd\u5199 ",(0,l.kt)("inlineCode",{parentName:"p"},"serve")," \u51fd\u6570\u5373\u53ef\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"class CustomService(Service):\n    def serve(self, addr: str, port: int, handler_list: t.List[str] = None) -> None:\n        ...\n\nsvc = CustomService()\n\n@svc.api(...)\ndef handler(data):\n    ...\n")),(0,l.kt)("p",null,"\u8bf4\u660e:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},"PipelineHandler.add_api")," \u51fd\u6570\u6dfb\u52a0\u7684 handler \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"api")," \u4ee5\u53ca\u5b9e\u4f8b\u5316\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"Service.api")," decorator \u6dfb\u52a0\u7684 handler \u53ef\u4ee5\u540c\u65f6\u751f\u6548"),(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"Service"),", \u9700\u8981\u5728 model \u4e2d\u5b9e\u4f8b\u5316\u81ea\u5b9a\u4e49\u7684 Service \u7c7b")),(0,l.kt)("h3",{id:"\u81ea\u5b9a\u4e49-request-\u548c-response"},"\u81ea\u5b9a\u4e49 Request \u548c Response"),(0,l.kt)("p",null,"Request \u548c Response \u5206\u522b\u662f\u7528\u4e8e\u63a5\u6536\u7528\u6237\u8bf7\u6c42\u548c\u8fd4\u56de\u7ed9\u7528\u6237\u7ed3\u679c\u7684\u5904\u7406\u7c7b, \u53ef\u4ee5\u7b80\u5355\u7684\u7406\u89e3\u6210\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"handler")," \u7684\u524d\u5904\u7406\u548c\u540e\u5904\u7406\u903b\u8f91"),(0,l.kt)("p",null,"Starwhale \u5c06\u652f\u6301 Dataset \u5185\u7f6e\u7c7b\u578b\u7684 Request \u5b9e\u73b0\u4ee5\u53ca Json Response \u7684\u5b9e\u73b0, \u540c\u65f6\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5904\u7406\u903b\u8f91\u6765\u4f7f\u7528, \u81ea\u5b9a\u4e49\u7684\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'import typing as t\n\nfrom starwhale.api.service import (\n    Request,\n    Service,\n    Response,\n)\n\nclass CustomInput(Request):\n    def load(self, req: t.Any) -> t.Any:\n        return req\n\n\nclass CustomOutput(Response):\n    def __init__(self, prefix: str) -> None:\n        self.prefix = prefix\n\n    def dump(self, req: str) -> bytes:\n        return f"{self.prefix} {req}".encode("utf-8")\n\nsvc = Service()\n\n@svc.api(request=CustomInput(), response=CustomOutput("hello"))\ndef foo(data: t.Any) -> t.Any:\n    ...\n')))}d.isMDXComponent=!0}}]);